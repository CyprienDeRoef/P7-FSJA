# ──────────────────────────────────────────────────────────────────────
#  Logstash pipeline – MicroCRM
#
#  Flux : Spring Boot (TCP JSON) ──► Logstash ──► Elasticsearch
# ──────────────────────────────────────────────────────────────────────

input {
  tcp {
    port  => 5000
    # json_lines : un objet JSON par ligne, envoyé par LogstashTcpSocketAppender
    codec => json_lines
  }
}

filter {
  # Normalise le niveau de log en majuscules (INFO, WARN, ERROR…)
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # Utilise le timestamp généré par Spring Boot comme @timestamp Elasticsearch
  if [timeMillis] {
    date {
      match  => ["timeMillis", "UNIX_MS"]
      target => "@timestamp"
    }
  }

  # Supprime les champs techniques internes de Logstash
  mutate {
    remove_field => ["port", "host", "@version"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    # Index journalier : microcrm-logs-2025.01.23
    index => "microcrm-logs-%{+YYYY.MM.dd}"
  }

  # Décommenter pour déboguer le pipeline directement dans les logs Logstash :
  # stdout { codec => rubydebug }
}
